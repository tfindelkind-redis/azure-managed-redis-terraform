name: Test With-Modules Example

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Clean up resources after testing'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write    # Required for OIDC authentication
  contents: read

env:
  TF_VERSION: "1.7.5"
  ARM_SKIP_PROVIDER_REGISTRATION: "true"

jobs:
  test-with-modules:
    name: Test With-Modules Example
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: false

    - name: Set ARM Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
        echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

    - name: Deploy With-Modules Example
      id: deploy
      run: |
        cd examples/with-modules
        
        # Generate unique resource names
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        REDIS_NAME="redis-modules-test-${TIMESTAMP}"
        
        # Create terraform.tfvars
        cat > terraform.tfvars << EOF
        resource_group_name = "rg-azure-managed-redis-terraform"
        location = "eastus"
        redis_name = "${REDIS_NAME}"
        environment = "testing"
        create_resource_group = false
        EOF
        
        echo "terraform_dir=$(pwd)" >> $GITHUB_OUTPUT
        echo "redis_name=${REDIS_NAME}" >> $GITHUB_OUTPUT
        
        # Initialize and deploy
        terraform init
        terraform plan -input=false
        terraform apply -auto-approve -input=false
        
        echo "✅ With-modules example deployed successfully"

    - name: Test Redis Modules
      run: |
        cd examples/with-modules
        
        # Get connection string
        CONNECTION_STRING=$(terraform output -raw connection_string)
        
        # Install redis-cli for testing
        sudo apt-get update && sudo apt-get install -y redis-tools
        
        echo "⏳ Waiting for Azure Redis keys to propagate (this can take 20-40 seconds)..."
        sleep 30
        
        # Retry function for Redis commands
        retry_redis_command() {
          local max_retries=3
          local retry_delay=10
          local attempt=1
          local cmd="$@"
          
          while [ $attempt -le $max_retries ]; do
            output=$(eval "$cmd" 2>&1)
            exit_code=$?
            
            if echo "$output" | grep -q "WRONGPASS\|NOAUTH"; then
              echo "⚠️  Attempt $attempt/$max_retries: Authentication still propagating, waiting ${retry_delay}s..."
              sleep $retry_delay
              attempt=$((attempt + 1))
            elif [ $exit_code -eq 0 ]; then
              echo "$output"
              return 0
            else
              echo "❌ Command failed: $output"
              return 1
            fi
          done
          
          echo "❌ Command failed after $max_retries attempts"
          return 1
        }
        
        # Test basic Redis operations
        echo "Testing Redis connectivity with PING..."
        if ! retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" ping"; then
          echo "❌ PING test failed"
          exit 1
        fi
        echo "✅ PING successful"
        
        # Test RedisJSON module
        echo "Testing RedisJSON module..."
        if ! retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" JSON.SET user:1 $ '{\"name\":\"John\",\"age\":30,\"city\":\"New York\"}'"; then
          echo "❌ JSON.SET failed"
          exit 1
        fi
        JSON_RESULT=$(retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" JSON.GET user:1 $.name")
        echo "✅ RedisJSON test successful"
        
        # Test RediSearch module
        echo "Testing RediSearch module..."
        if ! retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" FT.CREATE idx:users ON JSON PREFIX 1 user: SCHEMA $.name AS name TEXT $.age AS age NUMERIC"; then
          echo "❌ FT.CREATE failed"
          exit 1
        fi
        retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" FT.SEARCH idx:users \"John\"" > /dev/null
        echo "✅ RediSearch test successful"
        
        # Test RedisBloom module
        echo "Testing RedisBloom module..."
        if ! retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" BF.ADD users_bloom \"user:1\""; then
          echo "❌ BF.ADD failed"
          exit 1
        fi
        BLOOM_RESULT=$(retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" BF.EXISTS users_bloom \"user:1\"")
        echo "✅ RedisBloom test successful"
        
        # Test RedisTimeSeries module
        echo "Testing RedisTimeSeries module..."
        if ! retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" TS.CREATE temperature:room1 LABELS room 1 sensor temperature"; then
          echo "❌ TS.CREATE failed"
          exit 1
        fi
        retry_redis_command "redis-cli -u \"$CONNECTION_STRING\" TS.ADD temperature:room1 \"*\" 22.5" > /dev/null
        echo "✅ RedisTimeSeries test successful"
        
        # Validate results
        if [ "$JSON_RESULT" = '"John"' ] && [ "$BLOOM_RESULT" = "1" ]; then
          echo "✅ All Redis modules test successful"
          echo "  - JSON result: $JSON_RESULT"
          echo "  - Bloom result: $BLOOM_RESULT"
        else
          echo "❌ Redis modules test failed"
          echo "JSON result: $JSON_RESULT"
          echo "Bloom result: $BLOOM_RESULT"
          exit 1
        fi

    - name: Display Connection Information
      run: |
        cd examples/with-modules
        
        echo "## With-Modules Example Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "- Redis Name: ${{ steps.deploy.outputs.redis_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Resource Group: rg-azure-managed-redis-terraform" >> $GITHUB_STEP_SUMMARY
        echo "- Location: East US" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Status" >> $GITHUB_STEP_SUMMARY
        echo "✅ Deployment: Successful" >> $GITHUB_STEP_SUMMARY
        echo "✅ Connectivity: Working" >> $GITHUB_STEP_SUMMARY
        echo "✅ RedisJSON Module: Functional" >> $GITHUB_STEP_SUMMARY
        echo "✅ RediSearch Module: Functional" >> $GITHUB_STEP_SUMMARY
        echo "✅ RedisBloom Module: Functional" >> $GITHUB_STEP_SUMMARY
        echo "✅ RedisTimeSeries Module: Functional" >> $GITHUB_STEP_SUMMARY

    - name: Clean Up Resources
      if: always() && github.event.inputs.cleanup == 'true'
      run: |
        cd examples/with-modules
        
        echo "Cleaning up test resources..."
        terraform destroy -auto-approve -input=false
        echo "✅ Resources cleaned up"
