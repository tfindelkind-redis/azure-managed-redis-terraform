name: Nightly Validation

on:
  schedule:
    # Run every night at 2 AM UTC - only once a week 
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_deployment:
        description: 'Actually deploy resources for testing'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write    # Required for OIDC authentication
  contents: read
  issues: write      # Required for creating API update issues

env:
  TF_VERSION: "1.7.5"
  ARM_SKIP_PROVIDER_REGISTRATION: "true"

jobs:
  api-version-check:
    name: Check Azure API Versions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: false
      continue-on-error: true

    - name: Check Latest Redis Enterprise API Version
      id: api_check
      run: |
        # Get the latest API version for Redis Enterprise
        LATEST_API=$(az provider show --namespace Microsoft.Cache --query "resourceTypes[?resourceType=='redisEnterprise'].apiVersions[0]" -o tsv)
        # Extract current API version (handles both preview and stable versions)
        CURRENT_API=$(grep "redis_enterprise_api_version" modules/managed-redis/locals.tf | grep -o '"[^"]*"' | tr -d '"')
        
        echo "latest_api=$LATEST_API" >> $GITHUB_OUTPUT
        echo "current_api=$CURRENT_API" >> $GITHUB_OUTPUT
        
        if [ "$LATEST_API" != "$CURRENT_API" ]; then
          echo "api_outdated=true" >> $GITHUB_OUTPUT
          echo "::warning::API version outdated. Current: $CURRENT_API, Latest: $LATEST_API"
        else
          echo "api_outdated=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Issue for Outdated API
      if: steps.api_check.outputs.api_outdated == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['api-version', 'automated'],
            state: 'open'
          });
          
          if (issues.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Update Azure Redis Enterprise API Version',
              body: `## API Version Update Needed
              
              Current API version: \`${{ steps.api_check.outputs.current_api }}\`
              Latest API version: \`${{ steps.api_check.outputs.latest_api }}\`
              
              Please update the API version in:
              - \`modules/managed-redis/locals.tf\`
              - Test all examples after updating
              - Update documentation if new features are available
              
              This issue was created automatically by the nightly validation workflow.`,
              labels: ['api-version', 'automated', 'enhancement']
            });
          }

  provider-update-check:
    name: Check Provider Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Check AzureRM Provider Version
      id: provider_check
      run: |
        cd modules/managed-redis
        
        # Get current version constraint from versions.tf
        CURRENT_CONSTRAINT=$(grep -A 2 'azurerm = {' versions.tf | grep 'version' | grep -o '"[^"]*"' | tr -d '"')
        echo "current_constraint=$CURRENT_CONSTRAINT" >> $GITHUB_OUTPUT
        
        # Initialize with upgrade to get latest available version
        terraform init -upgrade
        
        # Get the actual version from lock file
        CURRENT_VERSION=$(grep -A 1 'provider "registry.terraform.io/hashicorp/azurerm"' .terraform.lock.hcl | grep 'version' | grep -o '"[^"]*"' | tr -d '"' | head -1)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        # Query Terraform Registry API for latest azurerm version
        LATEST_VERSION=$(curl -s https://registry.terraform.io/v1/providers/hashicorp/azurerm | jq -r '.version')
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        echo "Current constraint: $CURRENT_CONSTRAINT"
        echo "Current version: $CURRENT_VERSION"
        echo "Latest version: $LATEST_VERSION"
        
        # Check if there's a newer minor version available
        if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
          echo "provider_outdated=true" >> $GITHUB_OUTPUT
          echo "::warning::AzureRM provider outdated. Current: $CURRENT_VERSION, Latest: $LATEST_VERSION"
        else
          echo "provider_outdated=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Issue for Outdated Provider
      if: steps.provider_check.outputs.provider_outdated == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['provider-version', 'automated'],
            state: 'open'
          });
          
          if (issues.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Update AzureRM Provider Version',
              body: `## AzureRM Provider Update Available
              
              Current version constraint: \`${{ steps.provider_check.outputs.current_constraint }}\`
              Current resolved version: \`${{ steps.provider_check.outputs.current_version }}\`
              Latest available version: \`${{ steps.provider_check.outputs.latest_version }}\`
              
              **Action Required:**
              1. Review the [AzureRM Provider Changelog](https://github.com/hashicorp/terraform-provider-azurerm/blob/main/CHANGELOG.md)
              2. Update version constraint in:
                 - \`modules/managed-redis/versions.tf\`
                 - All example \`providers.tf\` files
              3. Test all examples with the new version
              4. Update \`.terraform.lock.hcl\` files
              5. Update documentation if new features are available
              
              **Files to Update:**
              - \`modules/managed-redis/versions.tf\`
              - \`examples/simple/providers.tf\`
              - \`examples/with-modules/providers.tf\`
              - \`examples/high-availability/providers.tf\`
              - \`examples/geo-replication/providers.tf\`
              - \`examples/enterprise-security/providers.tf\`
              
              This issue was created automatically by the nightly validation workflow.`,
              labels: ['provider-version', 'automated', 'enhancement']
            });
          }

  azapi-provider-update-check:
    name: Check AzAPI Provider Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Check AzAPI Provider Version
      id: azapi_check
      run: |
        cd modules/managed-redis
        
        # Get current version constraint from versions.tf
        CURRENT_CONSTRAINT=$(grep -A 2 'azapi = {' versions.tf | grep 'version' | grep -o '"[^"]*"' | tr -d '"')
        echo "current_constraint=$CURRENT_CONSTRAINT" >> $GITHUB_OUTPUT
        
        # Initialize with upgrade to get latest available version
        terraform init -upgrade
        
        # Get the actual version from lock file
        CURRENT_VERSION=$(grep -A 1 'provider "registry.terraform.io/azure/azapi"' .terraform.lock.hcl | grep 'version' | grep -o '"[^"]*"' | tr -d '"' | head -1)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        # Query Terraform Registry API for latest azapi version
        LATEST_VERSION=$(curl -s https://registry.terraform.io/v1/providers/Azure/azapi | jq -r '.version')
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        echo "Current constraint: $CURRENT_CONSTRAINT"
        echo "Current version: $CURRENT_VERSION"
        echo "Latest version: $LATEST_VERSION"
        
        # Check if there's a newer minor version available
        if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
          echo "azapi_outdated=true" >> $GITHUB_OUTPUT
          echo "::warning::AzAPI provider outdated. Current: $CURRENT_VERSION, Latest: $LATEST_VERSION"
        else
          echo "azapi_outdated=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Issue for Outdated AzAPI Provider
      if: steps.azapi_check.outputs.azapi_outdated == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['azapi-provider-version', 'automated'],
            state: 'open'
          });
          
          if (issues.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Update AzAPI Provider Version',
              body: `## AzAPI Provider Update Available
              
              Current version constraint: \`${{ steps.azapi_check.outputs.current_constraint }}\`
              Current resolved version: \`${{ steps.azapi_check.outputs.current_version }}\`
              Latest available version: \`${{ steps.azapi_check.outputs.latest_version }}\`
              
              **Action Required:**
              1. Review the [AzAPI Provider Changelog](https://github.com/Azure/terraform-provider-azapi/blob/main/CHANGELOG.md)
              2. Update version constraint in:
                 - \`modules/managed-redis/versions.tf\`
                 - All example \`providers.tf\` files
              3. Test all examples with the new version (especially enterprise-security)
              4. Update \`.terraform.lock.hcl\` files
              5. Check for new Azure API features that may be supported
              
              **Files to Update:**
              - \`modules/managed-redis/versions.tf\`
              - \`examples/simple/providers.tf\`
              - \`examples/with-modules/providers.tf\`
              - \`examples/high-availability/providers.tf\`
              - \`examples/geo-replication/providers.tf\`
              - \`examples/enterprise-security/providers.tf\`
              
              **Note:** AzAPI updates often include support for new Azure features and API versions. Review carefully for potential enhancements.
              
              This issue was created automatically by the nightly validation workflow.`,
              labels: ['azapi-provider-version', 'automated', 'enhancement']
            });
          }

  test-deployment:
    name: Test Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.test_deployment == 'true' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: false

    - name: Set ARM Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
        echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

    - name: Deploy Test Instance
      run: |
        cd examples/simple
        
        # Generate unique resource names
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        RG_NAME="rg-azure-managed-redis-terraform"
        REDIS_NAME="redis-test-${TIMESTAMP}"
        
        # Create terraform.tfvars
        cat > terraform.tfvars << EOF
        resource_group_name = "${RG_NAME}"
        location = "North Europe"
        redis_name = "${REDIS_NAME}"
        environment = "testing"
        create_resource_group = false
        EOF
        
        # Initialize and deploy
        terraform init
        terraform plan -input=false
        terraform apply -auto-approve -input=false
        
        # Get connection details
        HOSTNAME=$(terraform output -raw hostname)
        PRIMARY_KEY=$(terraform state show 'module.redis_enterprise.data.azapi_resource_action.database_keys[0]' | grep 'primaryKey' | sed -n 's/.*primaryKey[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p')
        PORT=10000
        
        # Install redis-cli for testing
        sudo apt-get update && sudo apt-get install -y redis-tools
        
        # Test basic Redis operations
        echo "Testing Redis connectivity..."
        redis-cli -h "$HOSTNAME" -p "$PORT" --tls -a "$PRIMARY_KEY" --no-auth-warning ping
        
        echo "Testing basic Redis commands..."
        redis-cli -h "$HOSTNAME" -p "$PORT" --tls -a "$PRIMARY_KEY" --no-auth-warning SET nightly-test "test-success-$(date +%s)"
        RESULT=$(redis-cli -h "$HOSTNAME" -p "$PORT" --tls -a "$PRIMARY_KEY" --no-auth-warning GET nightly-test)
        
        if [[ "$RESULT" == *"test-success"* ]]; then
          echo "✅ Redis deployment test successful"
        else
          echo "❌ Redis deployment test failed"
          exit 1
        fi
        
        # Clean up resources
        echo "Cleaning up test resources..."
        terraform destroy -auto-approve -input=false

  region-availability-check:
    name: Check Region Availability
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: false

    - name: Check Redis Enterprise Availability
      run: |
        echo "Checking Redis Enterprise availability across regions..."
        
        # List of important regions to check
        REGIONS=("eastus" "westus2" "northeurope" "westeurope" "southeastasia" "australiaeast")
        
        for region in "${REGIONS[@]}"; do
          echo "Checking region: $region"
          
          # Check if Redis Enterprise is available in the region
          AVAILABLE=$(az vm list-skus --location $region --resource-type virtualMachines --query "[?contains(name, 'Standard_D2s_v3')] | length(@)" -o tsv 2>/dev/null || echo "0")
          
          if [ "$AVAILABLE" -gt 0 ]; then
            echo "✅ $region: Available"
          else
            echo "❌ $region: Not available"
          fi
        done

  create-nightly-report:
    name: Create Nightly Report
    runs-on: ubuntu-latest
    needs: [api-version-check, provider-update-check, azapi-provider-update-check, test-deployment, region-availability-check]
    if: always()
    
    steps:
    - name: Create Summary Report
      run: |
        echo "# Nightly Validation Report - $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- API Version Check: ${{ needs.api-version-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- AzureRM Provider Update Check: ${{ needs.provider-update-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- AzAPI Provider Update Check: ${{ needs.azapi-provider-update-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Test Deployment: ${{ needs.test-deployment.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Region Availability: ${{ needs.region-availability-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add any failures or important information
        if [[ "${{ needs.api-version-check.result }}" != "success" ]] || 
           [[ "${{ needs.test-deployment.result }}" != "success" ]]; then
          echo "## ⚠️ Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "Please check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ✅ All Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "Repository is healthy and up to date." >> $GITHUB_STEP_SUMMARY
        fi
